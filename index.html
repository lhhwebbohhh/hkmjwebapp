<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ€„ é¦™æ¸¯éº»é›€è¨ˆç•ª WebApp V3.3</title>
    <style>
        :root {
            --mahjong-green: #1a5d3a; --mahjong-green-dark: #0f3d24;
            --mahjong-green-light: #2d8659; --mahjong-felt: #0a4028;
            --gold: #ffd700; --gold-dark: #daa520; --red: #dc2626;
            --white: #ffffff; --cream: #f5f5dc; --shadow: rgba(0,0,0,0.3);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Microsoft JhengHei',sans-serif;
            background:linear-gradient(135deg,var(--mahjong-green) 0%,var(--mahjong-felt) 100%);
            color:var(--white); min-height:100vh; padding:20px; padding-bottom:90px;
        }
        .container { max-width:1200px; margin:0 auto; }
        .header {
            text-align:center; margin-bottom:30px; padding:20px;
            background:rgba(255,255,255,0.1); border-radius:15px;
            backdrop-filter:blur(10px); border:2px solid var(--gold);
        }
        .header h1 { font-size:2.2rem; color:var(--gold); text-shadow:2px 2px 4px var(--shadow); margin-bottom:5px; }
        .header .subtitle { font-size:0.95rem; color:var(--cream); opacity:0.9; }
        .page { display:none; }
        .page.active { display:block; animation:fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
        .card {
            background:rgba(255,255,255,0.95); color:#333;
            border-radius:12px; padding:25px; margin-bottom:20px;
            box-shadow:0 8px 20px var(--shadow);
        }
        .card h2 { color:var(--mahjong-green); border-bottom:3px solid var(--gold); padding-bottom:10px; margin-bottom:20px; font-size:1.4rem; }
        .form-group { margin-bottom:18px; }
        .form-group label { display:block; margin-bottom:8px; font-weight:600; color:var(--mahjong-green-dark); }
        .form-group input[type="text"],.form-group input[type="number"],.form-group select {
            width:100%; padding:12px; border:2px solid var(--mahjong-green-light);
            border-radius:8px; font-size:1rem; transition:all 0.3s; background:white;
        }
        .form-group input:focus,.form-group select:focus {
            outline:none; border-color:var(--gold); box-shadow:0 0 0 3px rgba(255,215,0,0.2);
        }
        .btn {
            padding:12px 24px; border:none; border-radius:8px;
            font-size:1rem; font-weight:600; cursor:pointer;
            transition:all 0.3s; box-shadow:0 4px 6px var(--shadow);
            text-align:center; justify-content:center;
        }
        .btn:active { transform:translateY(2px); }
        .btn-primary { background:var(--gold); color:var(--mahjong-green-dark); }
        .btn-primary:hover { background:var(--gold-dark); }
        .btn-secondary { background:var(--mahjong-green-light); color:var(--white); }
        .btn-secondary:hover { background:var(--mahjong-green); }
        .btn-danger { background:var(--red); color:var(--white); }
        .btn-danger:hover { background:#b91c1c; }
        .btn-warning { background:#f59e0b; color:white; }
        .btn-warning:hover { background:#d97706; }
        .btn-full { width:100%; }
        .btn-group { display:flex; gap:10px; flex-wrap:wrap; }
        .toggle-section {
            display:flex; align-items:center; justify-content:space-between;
            padding:15px; background:rgba(42,157,143,0.1); border-radius:8px; margin-bottom:10px;
        }
        .toggle { position:relative; width:60px; height:30px; cursor:pointer; }
        .toggle input { opacity:0; width:0; height:0; }
        .toggle-slider { position:absolute; top:0; left:0; right:0; bottom:0; background:#ccc; border-radius:30px; transition:0.3s; }
        .toggle-slider:before { position:absolute; content:""; height:22px; width:22px; left:4px; bottom:4px; background:white; border-radius:50%; transition:0.3s; }
        .toggle input:checked + .toggle-slider { background:var(--gold); }
        .toggle input:checked + .toggle-slider:before { transform:translateX(30px); }
        .radio-group { display:flex; gap:12px; flex-wrap:wrap; }
        .radio-option { flex:1; min-width:110px; }
        .radio-option input[type="radio"] { display:none; }
        .radio-option label { display:block; padding:11px; border:2px solid var(--mahjong-green-light); border-radius:8px; text-align:center; cursor:pointer; transition:all 0.3s; background:white; font-size:0.95rem; }
        .radio-option input[type="radio"]:checked + label { background:var(--mahjong-green); color:white; border-color:var(--gold); }
        .radio-option.cheat-option input[type="radio"]:checked + label { background:var(--red); border-color:#b91c1c; }
        /* å¤šé¸checkboxæ¨£å¼ï¼ˆé£Ÿç³Šè€…/å‡ºéŠƒè€…å…±ç”¨ï¼‰ */
        .multi-option { flex:1; min-width:110px; }
        .multi-option input[type="checkbox"] { display:none; }
        .multi-option label { display:block; padding:11px; border:2px solid var(--mahjong-green-light); border-radius:8px; text-align:center; cursor:pointer; transition:all 0.3s; background:white; font-size:0.95rem; }
        .multi-option input[type="checkbox"]:checked + label { background:var(--mahjong-green); color:white; border-color:var(--gold); box-shadow:0 0 0 3px rgba(26,93,58,0.2); }
        .multi-info-box { display:none; margin-top:10px; padding:11px 14px; background:rgba(255,152,0,0.1); border-left:3px solid #f59e0b; border-radius:6px; font-size:0.88rem; color:#555; }
        .collapsible { background:rgba(42,157,143,0.1); border-radius:8px; margin-top:15px; overflow:hidden; }
        .collapsible-header { padding:14px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; font-weight:600; color:var(--mahjong-green-dark); }
        .collapsible-header:hover { background:rgba(42,157,143,0.2); }
        .collapsible-content { max-height:0; overflow:hidden; transition:max-height 0.3s ease; }
        .collapsible-content.open { max-height:2000px; padding:15px; }
        .player-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:14px; margin-bottom:20px; }
        .player-card { background:white; border:3px solid var(--mahjong-green-light); border-radius:12px; padding:18px; text-align:center; position:relative; transition:all 0.3s; color:#333; }
        .player-card.dealer { border-color:var(--gold); background:linear-gradient(135deg,#fff9e6,#fff); box-shadow:0 0 20px rgba(255,215,0,0.4); }
        .player-card.dealer::before {
            content:"èŠ"; position:absolute; top:-10px; right:-10px;
            background:var(--gold); color:var(--mahjong-green-dark);
            width:33px; height:33px; border-radius:50%; display:flex;
            align-items:center; justify-content:center; font-weight:bold; font-size:1.1rem;
        }
        .player-emoji { font-size:2rem; margin-bottom:4px; }
        .player-name { font-size:1.1rem; font-weight:bold; color:var(--mahjong-green-dark); margin-bottom:6px; }
        .player-score { font-size:1.7rem; font-weight:bold; margin-bottom:4px; }
        .player-score.positive { color:#059669; }
        .player-score.negative { color:var(--red); }
        .player-position { font-size:0.82rem; color:#666; margin-bottom:4px; }
        .game-info { background:rgba(255,215,0,0.2); border-left:4px solid var(--gold); padding:15px; border-radius:8px; margin-bottom:20px; }
        .game-info-item { display:flex; justify-content:space-between; margin-bottom:6px; font-size:0.98rem; }
        .game-info-item strong { color:var(--mahjong-green-dark); }
        .consecutive-banner { margin-top:8px; padding:10px; background:rgba(220,38,38,0.25); border-radius:8px; color:#ff6b6b; font-weight:bold; text-align:center; animation:pulse 1.5s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.7} }
        #gameTimer { font-family:'Courier New',monospace; font-size:1.05rem; color:var(--gold); font-weight:bold; letter-spacing:2px; }
        #gameTimer.running { animation:timerPulse 2s infinite; }
        @keyframes timerPulse { 0%,100%{opacity:1} 50%{opacity:0.45} }
        .bottom-nav { position:fixed; bottom:0; left:0; right:0; background:var(--mahjong-green-dark); padding:10px 4px; display:flex; justify-content:space-around; box-shadow:0 -4px 20px var(--shadow); z-index:1000; }
        .nav-btn { background:none; border:none; color:var(--cream); font-size:0.68rem; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:3px; padding:4px 6px; border-radius:8px; transition:all 0.3s; }
        .nav-btn:hover,.nav-btn.active { background:rgba(255,215,0,0.2); color:var(--gold); }
        .nav-btn-icon { font-size:1.25rem; }
        .fan-group { margin-bottom:8px; border-radius:8px; overflow:hidden; border:1px solid #e0e0e0; }
        .fan-group-header { display:flex; justify-content:space-between; align-items:center; padding:11px 14px; background:var(--mahjong-green); color:white; cursor:pointer; font-weight:600; user-select:none; }
        .fan-group-header:hover { background:var(--mahjong-green-light); }
        .fan-group-header .group-badge { background:var(--gold); color:var(--mahjong-green-dark); padding:2px 9px; border-radius:20px; font-size:0.82rem; font-weight:bold; }
        .fan-group-content { display:none; padding:8px; background:white; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:7px; }
        .fan-group-content.open { display:grid; }
        .fan-item { display:flex; align-items:center; padding:9px; background:rgba(42,157,143,0.05); border:2px solid transparent; border-radius:8px; cursor:pointer; transition:all 0.2s; }
        .fan-item:hover { background:rgba(42,157,143,0.1); border-color:var(--mahjong-green-light); }
        .fan-item input[type="checkbox"] { margin-right:7px; width:17px; height:17px; cursor:pointer; flex-shrink:0; }
        .fan-item.checked { background:var(--mahjong-green-light); color:white; border-color:var(--gold); }
        .fan-label { flex:1; display:flex; justify-content:space-between; align-items:center; gap:4px; font-size:0.92rem; }
        .fan-value { font-weight:bold; color:var(--gold); background:rgba(0,0,0,0.2); padding:2px 5px; border-radius:4px; font-size:0.78rem; white-space:nowrap; }
        .fan-item.checked .fan-value { background:rgba(255,215,0,0.3); }
        .direct-fan-input { display:flex; align-items:center; gap:15px; justify-content:center; padding:15px; background:rgba(42,157,143,0.05); border-radius:12px; }
        .direct-fan-btn { width:52px; height:52px; border-radius:50%; border:none; background:var(--mahjong-green); color:white; font-size:1.7rem; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 8px var(--shadow); transition:all 0.2s; }
        .direct-fan-btn:hover { background:var(--mahjong-green-light); transform:scale(1.05); }
        .direct-fan-number { width:95px; text-align:center; font-size:2.3rem; font-weight:bold; color:var(--mahjong-green-dark); border:2px solid var(--mahjong-green-light); border-radius:12px; padding:9px; background:white; }
        .total-fan-display { background:var(--gold); color:var(--mahjong-green-dark); padding:18px; border-radius:12px; text-align:center; margin-bottom:18px; box-shadow:0 8px 20px var(--shadow); }
        .total-fan-display h3 { font-size:1.1rem; margin-bottom:8px; }
        .total-fan-display .fan-number { font-size:2.8rem; font-weight:bold; margin-bottom:4px; }
        .total-fan-display .money-amount { font-size:1.4rem; font-weight:bold; }
        .cheat-info-box { display:none; background:rgba(220,38,38,0.08); border-left:4px solid var(--red); padding:18px; border-radius:8px; margin-bottom:18px; }
        .cheat-info-box h3 { color:var(--red); margin-bottom:10px; }
        .cheat-penalty { font-size:1.4rem; font-weight:bold; color:var(--red); margin-top:8px; }
        .table { width:100%; border-collapse:collapse; margin-top:8px; }
        .table th,.table td { padding:9px; text-align:left; border-bottom:1px solid #ddd; }
        .table th { background:var(--mahjong-green); color:white; font-weight:600; font-size:0.9rem; }
        .table tr:hover { background:rgba(42,157,143,0.05); }
        .table-center { text-align:center !important; }
        .positive { color:#059669; } .negative { color:var(--red); }
        .history-item { background:white; border-left:4px solid var(--mahjong-green); padding:14px; margin-bottom:11px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.08); color:#333; }
        .history-item.cheat-record { border-left-color:var(--red); }
        .history-item.multi-win { border-left-color:#f59e0b; }
        .history-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:7px; font-weight:bold; color:var(--mahjong-green-dark); font-size:0.92rem; }
        .history-details { font-size:0.88rem; color:#555; line-height:1.6; }
        .history-money { margin-top:7px; padding:7px; background:rgba(42,157,143,0.05); border-radius:5px; font-size:0.85rem; }
        .celebration { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.9); display:none; align-items:center; justify-content:center; z-index:2000; }
        .celebration.active { display:flex; }
        .celebration-content { text-align:center; animation:zoomIn 0.5s ease-out; padding:20px; }
        @keyframes zoomIn { from{transform:scale(0.5);opacity:0} to{transform:scale(1);opacity:1} }
        .celebration h2 { font-size:2.3rem; color:var(--gold); margin-bottom:14px; }
        .celebration .fan-type { font-size:1.4rem; color:white; margin-bottom:14px; }
        .celebration .money { font-size:1.9rem; color:var(--gold); font-weight:bold; }
        .modal { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); display:none; align-items:center; justify-content:center; z-index:1500; padding:20px; }
        .modal.active { display:flex; }
        .modal-content { background:white; border-radius:12px; padding:22px; max-width:650px; max-height:90vh; overflow-y:auto; width:100%; box-shadow:0 20px 60px var(--shadow); color:#333; }
        .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:18px; padding-bottom:13px; border-bottom:2px solid var(--gold); }
        .modal-header h3 { color:var(--mahjong-green); font-size:1.2rem; }
        .modal-close { background:none; border:none; font-size:1.5rem; cursor:pointer; color:#999; }
        .modal-close:hover { color:var(--red); }
        .settlement-item { display:flex; align-items:center; justify-content:space-between; padding:12px 14px; background:rgba(42,157,143,0.08); border-radius:8px; margin-bottom:8px; font-size:0.97rem; color:#333; border:1px solid rgba(42,157,143,0.2); }
        .settlement-item.completed { opacity:0.45; text-decoration:line-through; }
        .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:11px; margin-bottom:18px; }
        .stat-card { background:linear-gradient(135deg,var(--mahjong-green-light),var(--mahjong-green)); color:white; padding:14px; border-radius:12px; text-align:center; box-shadow:0 4px 12px var(--shadow); }
        .stat-card-icon { font-size:1.7rem; margin-bottom:7px; }
        .stat-card-label { font-size:0.82rem; opacity:0.9; margin-bottom:4px; }
        .stat-card-value { font-size:1.1rem; font-weight:bold; }
        .player-setup-card { background:rgba(42,157,143,0.05); border:2px solid var(--mahjong-green-light); border-radius:12px; padding:14px; margin-bottom:14px; }
        .player-setup-header { display:flex; align-items:center; gap:10px; margin-bottom:9px; font-weight:bold; color:var(--mahjong-green-dark); }
        .selected-emoji-display { font-size:1.9rem; }
        .emoji-grid { display:grid; grid-template-columns:repeat(6,1fr); gap:5px; margin-top:7px; }
        .emoji-btn { font-size:1.5rem; padding:5px; border:2px solid transparent; border-radius:7px; cursor:pointer; background:rgba(42,157,143,0.05); text-align:center; transition:all 0.2s; }
        .emoji-btn:hover { background:rgba(42,157,143,0.15); border-color:var(--mahjong-green-light); }
        .emoji-btn.selected { border-color:var(--gold); background:rgba(255,215,0,0.2); }
        .saved-game-card { background:white; border-radius:12px; padding:16px; margin-bottom:11px; box-shadow:0 2px 8px rgba(0,0,0,0.08); cursor:pointer; border-left:4px solid var(--mahjong-green); transition:all 0.2s; color:#333; }
        .saved-game-card:hover { transform:translateY(-2px); box-shadow:0 4px 16px rgba(0,0,0,0.14); }
        .saved-game-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:7px; font-weight:bold; color:var(--mahjong-green-dark); }
        .saved-game-players { display:grid; grid-template-columns:repeat(2,1fr); gap:5px; margin-top:7px; }
        .saved-game-player { display:flex; justify-content:space-between; align-items:center; padding:4px 7px; background:rgba(42,157,143,0.05); border-radius:5px; font-size:0.85rem; }
        .delete-game-btn { background:none; border:none; color:#ccc; cursor:pointer; font-size:1.05rem; padding:3px 6px; border-radius:5px; transition:all 0.2s; }
        .delete-game-btn:hover { color:var(--red); background:rgba(220,38,38,0.1); }
        .chart-container { position:relative; width:100%; overflow-x:auto; background:white; border-radius:12px; padding:14px; margin-bottom:18px; }
        .chart-legend { display:flex; flex-wrap:wrap; gap:9px; justify-content:center; margin-bottom:9px; }
        .legend-item { display:flex; align-items:center; gap:5px; font-size:0.83rem; color:#555; }
        .legend-dot { width:11px; height:11px; border-radius:50%; flex-shrink:0; }
        .duration-badge { display:inline-flex; align-items:center; gap:6px; background:rgba(255,215,0,0.15); border:1px solid var(--gold); color:var(--mahjong-green-dark); padding:7px 13px; border-radius:20px; font-size:0.88rem; font-weight:600; margin-bottom:14px; }
        @media(max-width:768px){
            .header h1{font-size:1.5rem;}
            .player-grid{grid-template-columns:repeat(2,1fr);}
            .btn-group{flex-direction:column;align-items:stretch;}
            .radio-group{flex-direction:column;}
            .table{font-size:0.8rem;}
            .table th,.table td{padding:6px 3px;}
            .fan-group-content.open{grid-template-columns:repeat(auto-fill,minmax(125px,1fr));}
            .stats-grid{grid-template-columns:repeat(2,1fr);}
            .saved-game-players{grid-template-columns:1fr;}
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸ€„ é¦™æ¸¯éº»é›€è¨ˆç•ª WebApp</h1>
        <p class="subtitle">å…¨åŠŸèƒ½ç‰Œå±€ç®¡ç†ç³»çµ± V3.3 â±ï¸ğŸ”¥</p>
    </div>

    <!-- è¨­å®šé é¢ -->
    <div id="setupPage" class="page active">
        <div class="card">
            <h2>âš™ï¸ éŠæˆ²è¨­å®š</h2>
            <div class="form-group">
                <label>ğŸŒ¶ï¸ è¾£åº¦è¨­å®š</label>
                <div class="radio-group">
                    <div class="radio-option"><input type="radio" id="spicyFull" name="spicyLevel" value="full" checked><label for="spicyFull">ğŸ”¥ğŸ”¥ è¾£è¾£ä¸Š<br><small>æ¯ç•ªç¿»å€</small></label></div>
                    <div class="radio-option"><input type="radio" id="spicyHalf" name="spicyLevel" value="half"><label for="spicyHalf">ğŸŒ¶ï¸ åŠè¾£ä¸Š<br><small>4ç•ªå¾Œéš”ç•ªÃ—1.5</small></label></div>
                </div>
            </div>
            <div class="form-group">
                <label>ğŸ’° åº•æ³¨è¨­å®š</label>
                <div class="radio-group">
                    <div class="radio-option"><input type="radio" id="base1" name="baseRate" value="1" checked><label for="base1">äºŒäº”é›<br><small>$1</small></label></div>
                    <div class="radio-option"><input type="radio" id="base2" name="baseRate" value="2"><label for="base2">äº”ä¸€<br><small>$2</small></label></div>
                    <div class="radio-option"><input type="radio" id="base4" name="baseRate" value="4"><label for="base4">ä¸€äºŒèšŠ<br><small>$4</small></label></div>
                </div>
            </div>
            <div class="form-group">
                <label>èµ·ç³Šç•ªæ•¸</label>
                <select id="minFan"><option value="1">1ç•ªèµ·ç³Š</option><option value="2">2ç•ªèµ·ç³Š</option><option value="3" selected>3ç•ªèµ·ç³Š</option></select>
            </div>
            <div class="form-group">
                <label>çˆ†æ£šç•ªæ•¸</label>
                <select id="maxFan"><option value="8" selected>8ç•ªçˆ†æ£š</option><option value="10">10ç•ªçˆ†æ£š</option><option value="13">13ç•ªçˆ†æ£š</option></select>
            </div>
            <div class="toggle-section"><span><strong>æµå±€é€£èŠ</strong><br><small>æµå±€æ™‚èŠå®¶é€£èŠ</small></span><label class="toggle"><input type="checkbox" id="drawContinue" checked><span class="toggle-slider"></span></label></div>
            <div class="toggle-section"><span><strong>åŒ…ç‰Œè¦å‰‡</strong><br><small>é–‹å•ŸåŒ…ç‰ŒåŠŸèƒ½</small></span><label class="toggle"><input type="checkbox" id="baoPai" checked><span class="toggle-slider"></span></label></div>
            <div class="collapsible">
                <div class="collapsible-header" onclick="toggleCollapsible(this)"><span>ğŸ’¡ è¦å‰‡èªªæ˜</span><span>â–¼</span></div>
                <div class="collapsible-content">
                    <p style="margin-bottom:8px;color:#555;"><strong>è¾£è¾£ä¸Šï¼š</strong>æ¯ç•ªç¿»å€ã€‚</p>
                    <p style="margin-bottom:8px;color:#555;"><strong>åŠè¾£ä¸Šï¼š</strong>4ç•ªå¾Œéš”ç•ªÃ—1.5ä¸Šå‡ã€‚</p>
                    <p style="margin-bottom:8px;color:#555;"><strong>ä¸€ç‚®å¹¾éŸ¿ï¼š</strong>ä¸€äººå‡ºéŠƒï¼Œå¤šäººåŒæ™‚é£Ÿç³Šï¼Œå‡ºéŠƒè€…è³ æ¯ä½é£Ÿç³Šè€…å„ä¸€ä»½å°åƒ¹ã€‚</p>
                    <p style="margin-bottom:8px;color:#555;"><strong>è©ç³Šï¼š</strong>è©ç³Šè€…è³ ä¸‰å®¶å„ä¸Šé™ç•ªæ•¸å°åƒ¹ã€‚</p>
                    <p style="color:#555;"><strong>åŒ…ç‰Œï¼š</strong>åŒ…ç‰Œè€…ç¨è‡ªè³ å°åƒ¹Ã—3ã€‚</p>
                </div>
            </div>
        </div>
        <div class="card">
            <h2>ğŸ‘¥ ç©å®¶è¨­å®š</h2>
            <div id="playerSetupContainer"></div>
            <button class="btn btn-primary btn-full" onclick="startGame()">é–‹å§‹ç‰Œå±€ ğŸ®</button>
        </div>
    </div>

    <!-- éŠæˆ²é é¢ -->
    <div id="gamePage" class="page">
        <div class="game-info">
            <div class="game-info-item"><strong>ç•¶å‰å±€æ•¸ï¼š</strong><span id="currentRound">æ±ä¸€å±€</span></div>
            <div class="game-info-item"><strong>ç¬¬å¹¾å±€ï¼š</strong><span id="roundCount">ç¬¬ 1 å±€</span></div>
            <div class="game-info-item"><strong>é€²åº¦ï¼š</strong><span id="remainingRounds" style="color:var(--gold);"></span></div>
            <div class="game-info-item"><strong>â±ï¸ éŠæˆ²æ™‚é–“ï¼š</strong><span id="gameTimer">00:00:00</span></div>
            <div id="consecutiveInfo" style="display:none;" class="consecutive-banner"></div>
        </div>
        <div class="player-grid" id="playerGrid"></div>
        <div class="btn-group">
            <button class="btn btn-primary" style="flex:2;" onclick="showRecordWin()">è¨˜éŒ„é£Ÿç³Š ğŸ¯</button>
            <button class="btn btn-secondary" onclick="recordDraw()">æµå±€ â­ï¸</button>
            <button class="btn btn-warning" id="undoBtn" style="display:none;" onclick="undoLastRecord()">æ‚”æ£‹ â†©ï¸</button>
            <button class="btn btn-danger" onclick="endGame()">çµæŸ ğŸ</button>
        </div>
    </div>

    <!-- è¨˜éŒ„é£Ÿç³Šé é¢ -->
    <div id="recordPage" class="page">
        <div class="card">
            <h2>ğŸ¯ è¨˜éŒ„é£Ÿç³Š</h2>

            <!-- é£Ÿç³Šè€…ï¼šå¤šé¸æ”¯æ´ä¸€ç‚®å¹¾éŸ¿ -->
            <div class="form-group">
                <label>é£Ÿç³Šè€… <small style="color:#999;font-weight:normal;">ï¼ˆå¯å¤šé¸ = ä¸€ç‚®å¹¾éŸ¿ğŸ”¥ï¼‰</small></label>
                <div style="display:flex;gap:10px;flex-wrap:wrap;" id="winnerSelect"></div>
                <div class="multi-info-box" id="multiWinnerInfo"></div>
            </div>

            <div class="form-group">
                <label>é£Ÿç³Šæ–¹å¼</label>
                <div class="radio-group">
                    <div class="radio-option"><input type="radio" id="selfDraw" name="winMethod" value="self" checked onchange="updateWinMethod()"><label for="selfDraw">è‡ªæ‘¸ ğŸ™Œ</label></div>
                    <div class="radio-option"><input type="radio" id="fromOther" name="winMethod" value="other" onchange="updateWinMethod()"><label for="fromOther">å‡ºéŠƒ ğŸ¯</label></div>
                    <div class="radio-option cheat-option"><input type="radio" id="cheatWin" name="winMethod" value="cheat" onchange="updateWinMethod()"><label for="cheatWin">è©ç³Š âŒ</label></div>
                </div>
            </div>

            <!-- å‡ºéŠƒè€…ï¼šå–®é¸ -->
            <div class="form-group" id="loserSelectGroup" style="display:none;">
                <label>å‡ºéŠƒè€…</label>
                <div class="radio-group" id="loserSelect"></div>
            </div>

            <div class="form-group" id="baoPaiSelectGroup" style="display:none;">
                <label>åŒ…ç‰Œè€…</label>
                <div class="toggle-section"><span><strong>æœ‰åŒ…ç‰Œ</strong><br><small>åŒ…ç‰Œè€…ç¨è‡ªè³ å…¨éƒ¨</small></span><label class="toggle"><input type="checkbox" id="hasBaoPai" onchange="updateBaoPai()"><span class="toggle-slider"></span></label></div>
                <div class="radio-group" id="baoPaiPersonSelect" style="display:none;margin-top:10px;"></div>
            </div>

            <div class="cheat-info-box" id="cheatInfo"><h3>âš ï¸ è©ç³Šç½°å‰‡</h3><div id="cheatInfoText"></div></div>

            <div id="fanSelectorWrapper">
                <div class="form-group">
                    <label>å…¥ç•ªæ–¹å¼</label>
                    <div class="radio-group">
                        <div class="radio-option"><input type="radio" id="modeSelect" name="fanMode" value="select" checked onchange="updateFanMode()"><label for="modeSelect">é¸ç•ªå‹ ğŸ“‹</label></div>
                        <div class="radio-option"><input type="radio" id="modeDirect" name="fanMode" value="direct" onchange="updateFanMode()"><label for="modeDirect">ç›´æ¥å…¥ç•ª âœï¸</label></div>
                    </div>
                </div>
                <div id="fanSelectMode"><div class="form-group"><label>é¸æ“‡ç•ªå‹</label><div id="fanGroupContainer"></div></div></div>
                <div id="fanDirectMode" style="display:none;">
                    <div class="form-group"><label>è¼¸å…¥ç•ªæ•¸</label>
                        <div class="direct-fan-input">
                            <button class="direct-fan-btn" onclick="adjustDirectFan(-1)">ï¼</button>
                            <input type="number" id="directFanInput" value="3" min="0" max="99" class="direct-fan-number" oninput="updateTotalFan()">
                            <button class="direct-fan-btn" onclick="adjustDirectFan(1)">ï¼‹</button>
                        </div>
                    </div>
                </div>
                <div class="total-fan-display">
                    <h3>ç¸½ç•ªæ•¸</h3>
                    <div class="fan-number" id="totalFanDisplay">0 ç•ª</div>
                    <div class="money-amount" id="totalMoneyDisplay">$0</div>
                    <p id="capMessage" style="margin-top:7px;font-size:0.88rem;"></p>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" style="flex:1;" onclick="confirmWin()">ç¢ºèª âœ…</button>
                <button class="btn btn-secondary" onclick="cancelRecord()">å–æ¶ˆ âŒ</button>
            </div>
        </div>
    </div>

    <!-- ç•ªæ•¸è¡¨ -->
    <div id="fanTablePage" class="page">
        <div class="card">
            <h2>ğŸ“‹ ç•ªæ•¸å°ç…§è¡¨</h2>
            <table class="table">
                <thead><tr><th class="table-center">ç•ªæ•¸</th><th>ç‰Œå‹</th><th>èªªæ˜</th></tr></thead>
                <tbody>
                    <tr><td class="table-center"><strong>1ç•ª</strong></td><td>å¹³ç³Š</td><td>é †å­ï¼Œå†‡å­—ç‰Œ</td></tr>
                    <tr><td></td><td>è‡ªæ‘¸</td><td>è‡ªå·±æ‘¸ç‰Œé£Ÿç³Š</td></tr>
                    <tr><td></td><td>é–€å‰æ¸…</td><td>å†‡ä¸Šç¢°æ§“ï¼Œè‡ªæ‘¸</td></tr>
                    <tr><td></td><td>æ­£èŠ±</td><td>é–€é¢¨æˆ–åœˆé¢¨èŠ±ç‰Œ</td></tr>
                    <tr><td></td><td>é–€é¢¨åˆ»</td><td>ä¸‰éš»é–€é¢¨åˆ»å­</td></tr>
                    <tr><td></td><td>åœˆé¢¨åˆ»</td><td>ä¸‰éš»åœˆé¢¨åˆ»å­</td></tr>
                    <tr><td class="table-center"><strong>2ç•ª</strong></td><td>ä¸€å°èŠ±</td><td>æ‘¸é½Šæ˜¥å¤ç§‹å†¬æˆ–æ¢…è˜­èŠç«¹</td></tr>
                    <tr><td class="table-center"><strong>3ç•ª</strong></td><td>å°å°ç³Š</td><td>å››çµ„åˆ»å­</td></tr>
                    <tr><td></td><td>æ··ä¸€è‰²</td><td>å–®ä¸€èŠ±è‰²+å­—ç‰Œ</td></tr>
                    <tr><td class="table-center"><strong>6ç•ª</strong></td><td>å°ä¸‰å…ƒ</td><td>ä¸­ç™¼ç™½å…©åˆ»+ä¸€å°çœ¼</td></tr>
                    <tr><td></td><td>å°å››å–œ</td><td>æ±å—è¥¿åŒ—ä¸‰åˆ»+ä¸€å°çœ¼</td></tr>
                    <tr><td class="table-center"><strong>7ç•ª</strong></td><td>æ¸…ä¸€è‰²</td><td>å…¨éƒ¨å–®ä¸€èŠ±è‰²</td></tr>
                    <tr><td></td><td>å­—ä¸€è‰²</td><td>å…¨éƒ¨å­—ç‰Œ</td></tr>
                    <tr><td class="table-center"><strong>8ç•ª</strong></td><td>å¤§èŠ±ç³Š</td><td>æ‘¸é½Šå…¨éƒ¨8éš»èŠ±ç‰Œ</td></tr>
                    <tr><td class="table-center"><strong>10ç•ª</strong></td><td>å¤§ä¸‰å…ƒ</td><td>ä¸­ç™¼ç™½ä¸‰çµ„åˆ»å­</td></tr>
                    <tr><td></td><td>å¤§å››å–œ</td><td>æ±å—è¥¿åŒ—å››çµ„åˆ»å­</td></tr>
                    <tr><td class="table-center"><strong>13ç•ª</strong></td><td>åä¸‰ä¹ˆ</td><td>19è¬19ç­’19ç´¢7å­—å„ä¸€</td></tr>
                    <tr><td></td><td>å¤©ç³Š</td><td>èŠå®¶èµ·æ‰‹é£Ÿç³Š</td></tr>
                    <tr><td></td><td>åœ°ç³Š</td><td>èŠå®¶å‡ºç¬¬ä¸€éš»å³é£Ÿç³Š</td></tr>
                </tbody>
            </table>
        </div>
        <div class="card">
            <h2>ğŸ’° è¨ˆåˆ†èªªæ˜</h2>
            <div style="background:rgba(255,215,0,0.2);border-left:4px solid var(--gold);padding:14px;border-radius:8px;margin-bottom:14px;">
                <ul style="margin:0 0 0 18px;color:#555;font-size:0.95rem;">
                    <li><strong>è‡ªæ‘¸ï¼š</strong>ä¸‰å®¶å„ä»˜å°åƒ¹</li>
                    <li><strong>å‡ºéŠƒï¼š</strong>å‡ºéŠƒè€…ä»˜å°åƒ¹</li>
                    <li><strong>ä¸€ç‚®å¹¾éŸ¿ï¼š</strong>ä¸€äººå‡ºéŠƒï¼Œå¤šäººé£Ÿç³Šï¼Œå‡ºéŠƒè€…è³ æ¯ä½é£Ÿç³Šè€…å„ä¸€ä»½å°åƒ¹</li>
                    <li><strong>åŒ…ç‰Œï¼š</strong>åŒ…ç‰Œè€…è³ å°åƒ¹Ã—3</li>
                    <li><strong>è©ç³Šï¼š</strong>è³ ä¸‰å®¶å„ä¸Šé™ç•ªå°åƒ¹</li>
                </ul>
            </div>
            <h3 style="color:var(--mahjong-green);margin-bottom:7px;">ğŸ”¥ğŸ”¥ è¾£è¾£ä¸Š</h3>
            <table class="table">
                <thead><tr><th class="table-center">ç•ª</th><th class="table-center">äºŒäº”é›</th><th class="table-center">äº”ä¸€</th><th class="table-center">ä¸€äºŒèšŠ</th></tr></thead>
                <tbody>
                    <tr><td class="table-center">1</td><td class="table-center">$2</td><td class="table-center">$4</td><td class="table-center">$8</td></tr>
                    <tr><td class="table-center">2</td><td class="table-center">$4</td><td class="table-center">$8</td><td class="table-center">$16</td></tr>
                    <tr><td class="table-center">3</td><td class="table-center">$8</td><td class="table-center">$16</td><td class="table-center">$32</td></tr>
                    <tr><td class="table-center">4</td><td class="table-center">$16</td><td class="table-center">$32</td><td class="table-center">$64</td></tr>
                    <tr><td class="table-center">5</td><td class="table-center">$32</td><td class="table-center">$64</td><td class="table-center">$128</td></tr>
                    <tr><td class="table-center">6</td><td class="table-center">$64</td><td class="table-center">$128</td><td class="table-center">$256</td></tr>
                    <tr><td class="table-center">7</td><td class="table-center">$128</td><td class="table-center">$256</td><td class="table-center">$512</td></tr>
                    <tr><td class="table-center">8+</td><td class="table-center">$256</td><td class="table-center">$512</td><td class="table-center">$1024</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- çµ±è¨ˆ -->
    <div id="statsPage" class="page">
        <div class="card">
            <h2>ğŸ“Š çµ±è¨ˆæ•¸æ“š</h2>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-card-icon">ğŸ†</div><div class="stat-card-label">é£Ÿç³Šç‹</div><div class="stat-card-value" id="winKing">-</div></div>
                <div class="stat-card"><div class="stat-card-icon">ğŸ¯</div><div class="stat-card-label">è‡ªæ‘¸ç‹</div><div class="stat-card-value" id="selfDrawKing">-</div></div>
                <div class="stat-card"><div class="stat-card-icon">ğŸ’€</div><div class="stat-card-label">å‡ºéŠƒç‹</div><div class="stat-card-value" id="loserKing">-</div></div>
                <div class="stat-card"><div class="stat-card-icon">ğŸŒŸ</div><div class="stat-card-label">æœ€é«˜ç•ªæ•¸</div><div class="stat-card-value" id="highestFan">-</div></div>
                <div class="stat-card" style="background:linear-gradient(135deg,#b91c1c,#dc2626);"><div class="stat-card-icon">âŒ</div><div class="stat-card-label">è©ç³Šæ¬¡æ•¸</div><div class="stat-card-value" id="cheatKing">-</div></div>
                <div class="stat-card" style="background:linear-gradient(135deg,#7c3aed,#5b21b6);"><div class="stat-card-icon">ğŸ‘‘</div><div class="stat-card-label">æœ€é•·é€£èŠ</div><div class="stat-card-value" id="maxConsecutiveStat">-</div></div>
            </div>
            <table class="table">
                <thead><tr><th>ç©å®¶</th><th class="table-center">é‡‘é¡</th><th class="table-center">é£Ÿç³Š</th><th class="table-center">è‡ªæ‘¸</th><th class="table-center">å‡ºéŠƒ</th><th class="table-center">è©ç³Š</th><th class="table-center">å¹³å‡ç•ª</th></tr></thead>
                <tbody id="statsTableBody"></tbody>
            </table>
            <h3 style="color:var(--mahjong-green);margin-top:18px;margin-bottom:7px;">ğŸ€„ ç•ªå‹æ’è¡Œ</h3>
            <table class="table">
                <thead><tr><th>ç•ªå‹</th><th class="table-center">æ¬¡æ•¸</th></tr></thead>
                <tbody id="fanStatsBody"><tr><td colspan="2" style="text-align:center;color:#999;">æš«ç„¡æ•¸æ“š</td></tr></tbody>
            </table>
        </div>
    </div>

    <!-- æœ¬å±€è¨˜éŒ„ -->
    <div id="historyPage" class="page">
        <div class="card"><h2>ğŸ“œ æœ¬å±€è¨˜éŒ„</h2><div id="historyList"></div></div>
    </div>

    <!-- æ­·å²ç‰Œå±€ -->
    <div id="savedGamesPage" class="page">
        <div class="card">
            <h2>ğŸ—‚ï¸ æ­·å²ç‰Œå±€</h2>
            <p style="color:#666;margin-bottom:14px;font-size:0.88rem;">æœ€å¤šå„²å­˜ 15 å±€</p>
            <div id="savedGamesList"></div>
        </div>
    </div>
</div>

<!-- åº•éƒ¨å°èˆª -->
<div class="bottom-nav">
    <button class="nav-btn active" onclick="showPage('gamePage')"><span class="nav-btn-icon">ğŸ®</span><span>éŠæˆ²</span></button>
    <button class="nav-btn" onclick="showPage('fanTablePage')"><span class="nav-btn-icon">ğŸ“‹</span><span>ç•ªæ•¸è¡¨</span></button>
    <button class="nav-btn" onclick="showPage('statsPage')"><span class="nav-btn-icon">ğŸ“Š</span><span>çµ±è¨ˆ</span></button>
    <button class="nav-btn" onclick="showPage('historyPage')"><span class="nav-btn-icon">ğŸ“œ</span><span>æœ¬å±€</span></button>
    <button class="nav-btn" onclick="showPage('savedGamesPage')"><span class="nav-btn-icon">ğŸ—‚ï¸</span><span>æ­·å²å±€</span></button>
    <button class="nav-btn" onclick="showPage('setupPage')"><span class="nav-btn-icon">âš™ï¸</span><span>è¨­å®š</span></button>
</div>

<!-- æ…¶ç¥ -->
<div id="celebration" class="celebration">
    <div class="celebration-content">
        <h2>ğŸŠ æ­å–œæ­å–œï¼ ğŸŠ</h2>
        <div class="fan-type" id="celebrationFanType"></div>
        <div class="money" id="celebrationMoney"></div>
        <button class="btn btn-primary" style="margin-top:20px;" onclick="closeCelebration()">ç¹¼çºŒ â–¶ï¸</button>
    </div>
</div>

<!-- æ‰¾æ•¸Modal -->
<div id="settlementModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3>ğŸ’¸ æ‰¾æ•¸æ–¹æ¡ˆ</h3><button class="modal-close" onclick="closeSettlement()">âœ•</button></div>
        <div id="settlementContent"></div>
        <button class="btn btn-primary btn-full" style="margin-top:15px;" onclick="closeSettlement()">å®Œæˆï¼Œé–‹æ–°å±€ ğŸ®</button>
    </div>
</div>

<!-- æ­·å²è©³æƒ…Modal -->
<div id="savedGameModal" class="modal">
    <div class="modal-content" style="max-width:700px;">
        <div class="modal-header"><h3 id="savedGameModalTitle">ç‰Œå±€è©³æƒ…</h3><button class="modal-close" onclick="closeSavedGameModal()">âœ•</button></div>
        <div id="savedGameModalContent"></div>
    </div>
</div>
<script>
const EMOJI_OPTIONS=['ğŸ˜€','ğŸ˜','ğŸ¤©','ğŸ¥³','ğŸ˜¤','ğŸ¤”','ğŸ˜´','ğŸ¥µ','ğŸ¤‘','ğŸ‘‘','ğŸ¦','ğŸ¯','ğŸ¼','ğŸ¦Š','ğŸ¸','ğŸ²','ğŸ€','â­','ğŸ”¥','ğŸ’','ğŸ€„','ğŸ¯','ğŸ²','ğŸ®','ğŸ†','ğŸ’ª','ğŸ‘»','ğŸ¤–','ğŸ¦„','ğŸŒˆ'];
const MAX_SAVED_GAMES=15;
const CHART_COLORS=['#1a5d3a','#dc2626','#2563eb','#d97706'];
const fanTypes=[
    {name:'å¹³ç³Š',value:1},{name:'è‡ªæ‘¸',value:1},{name:'é–€å‰æ¸…',value:1},
    {name:'æ­£èŠ±',value:1},{name:'é–€é¢¨åˆ»',value:1},{name:'åœˆé¢¨åˆ»',value:1},
    {name:'æ¶æ§“ç³Š',value:1},{name:'æ§“ä¸Šè‡ªæ‘¸',value:1},{name:'æµ·åº•æ’ˆæœˆ',value:1},
    {name:'ä¸€å°èŠ±',value:2},{name:'å°å°ç³Š',value:3},{name:'æ··ä¸€è‰²',value:3},
    {name:'å°ä¸‰å…ƒ',value:6},{name:'å°å››å–œ',value:6},{name:'æ¸…ä¸€è‰²',value:7},
    {name:'å­—ä¸€è‰²',value:7},{name:'å¤§èŠ±ç³Š',value:8},{name:'å¤§ä¸‰å…ƒ',value:10},
    {name:'å¤§å››å–œ',value:10},{name:'åä¸‰ä¹ˆ',value:13},{name:'å¤©ç³Š',value:13},
    {name:'åœ°ç³Š',value:13},{name:'äººç³Š',value:13},{name:'ä¹å­é€£ç’°',value:13},
    {name:'åå…«ç¾…æ¼¢',value:13}
];

let gameState={
    settings:{spicyLevel:'full',baseRate:1,minFan:3,maxFan:8,drawContinue:true,baoPai:true},
    players:[],currentDealer:0,roundNumber:1,consecutiveDealer:0,
    history:[],stats:{},maxConsecutive:0,maxConsecutivePlayer:'',startTime:null
};
let playerProfiles=[];

// â•â•â• è¨ˆæ™‚å™¨ â•â•â•
let timerStartTimestamp=null,timerAccumulated=0,timerRunning=false,timerInterval=null;

function startTimer(){
    timerStartTimestamp=Date.now(); timerAccumulated=0; timerRunning=true;
    clearInterval(timerInterval); timerInterval=setInterval(updateTimerDisplay,1000);
    const el=document.getElementById('gameTimer');
    if(el){el.textContent='00:00:00';el.classList.add('running');}
}
function stopTimer(){
    timerAccumulated=getElapsedSeconds(); timerRunning=false; timerStartTimestamp=null;
    clearInterval(timerInterval);
    const el=document.getElementById('gameTimer');
    if(el)el.classList.remove('running');
}
function resetTimer(){
    clearInterval(timerInterval); timerStartTimestamp=null; timerAccumulated=0; timerRunning=false;
    const el=document.getElementById('gameTimer');
    if(el){el.textContent='00:00:00';el.classList.remove('running');}
}
function getElapsedSeconds(){
    if(!timerStartTimestamp)return timerAccumulated;
    return timerAccumulated+Math.floor((Date.now()-timerStartTimestamp)/1000);
}
function updateTimerDisplay(){
    const total=getElapsedSeconds();
    const h=Math.floor(total/3600),m=Math.floor((total%3600)/60),s=total%60;
    const el=document.getElementById('gameTimer');
    if(el)el.textContent=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}
function formatDuration(seconds){
    const h=Math.floor(seconds/3600),m=Math.floor((seconds%3600)/60),s=seconds%60;
    if(h>0)return `${h}å°æ™‚ ${m}åˆ† ${s}ç§’`;
    if(m>0)return `${m}åˆ† ${s}ç§’`;
    return `${s}ç§’`;
}
document.addEventListener('visibilitychange',()=>{
    if(document.visibilityState==='visible'&&timerRunning)updateTimerDisplay();
});

// â•â•â• åˆå§‹åŒ– â•â•â•
function init(){
    loadProfiles(); renderPlayerSetup();
    const saved=localStorage.getItem('mahjongGame');
    if(saved){
        if(confirm('ç™¼ç¾æœªå®Œæˆçš„ç‰Œå±€ï¼Œæ˜¯å¦ç¹¼çºŒï¼Ÿ')){
            gameState=JSON.parse(saved);
            if(gameState.timerAccumulated!==undefined){
                timerAccumulated=gameState.timerAccumulated;
                timerStartTimestamp=Date.now(); timerRunning=true;
                clearInterval(timerInterval); timerInterval=setInterval(updateTimerDisplay,1000);
                const el=document.getElementById('gameTimer');
                if(el)el.classList.add('running');
            }
            showPage('gamePage'); updateGameDisplay(); updateUndoBtn();
        } else { localStorage.removeItem('mahjongGame'); }
    }
}

// â•â•â• ç©å®¶ Profile â•â•â•
function loadProfiles(){
    const saved=localStorage.getItem('mahjongProfiles');
    playerProfiles=saved?JSON.parse(saved):[
        {name:'ç©å®¶1',emoji:'ğŸ˜€'},{name:'ç©å®¶2',emoji:'ğŸ˜'},
        {name:'ç©å®¶3',emoji:'ğŸ¤©'},{name:'ç©å®¶4',emoji:'ğŸ¥³'}
    ];
}
function saveProfiles(){localStorage.setItem('mahjongProfiles',JSON.stringify(playerProfiles));}

function renderPlayerSetup(){
    const positions=['æ±å®¶ï¼ˆèµ·èŠï¼‰','å—å®¶','è¥¿å®¶','åŒ—å®¶'];
    const container=document.getElementById('playerSetupContainer');
    container.innerHTML='';
    playerProfiles.forEach((profile,i)=>{
        const div=document.createElement('div');
        div.className='player-setup-card';
        div.innerHTML=`
            <div class="player-setup-header">
                <span class="selected-emoji-display" id="emojiDisplay${i}">${profile.emoji}</span>
                <span>${positions[i]}</span>
            </div>
            <div class="form-group" style="margin-bottom:8px;">
                <input type="text" id="player${i}" value="${profile.name}" placeholder="ç©å®¶åç¨±"
                    oninput="playerProfiles[${i}].name=this.value;saveProfiles();">
            </div>
            <div class="emoji-grid" id="emojiGrid${i}"></div>`;
        container.appendChild(div);
        renderEmojiGrid(i,profile.emoji);
    });
}
function renderEmojiGrid(playerIndex,selectedEmoji){
    const grid=document.getElementById(`emojiGrid${playerIndex}`);
    grid.innerHTML='';
    EMOJI_OPTIONS.forEach(emoji=>{
        const btn=document.createElement('button');
        btn.className=`emoji-btn ${emoji===selectedEmoji?'selected':''}`;
        btn.textContent=emoji;
        btn.onclick=()=>{
            playerProfiles[playerIndex].emoji=emoji; saveProfiles();
            document.getElementById(`emojiDisplay${playerIndex}`).textContent=emoji;
            grid.querySelectorAll('.emoji-btn').forEach(b=>b.classList.remove('selected'));
            btn.classList.add('selected');
        };
        grid.appendChild(btn);
    });
}

// â•â•â• é–‹å§‹éŠæˆ² â•â•â•
function startGame(){
    gameState.settings.spicyLevel=document.querySelector('input[name="spicyLevel"]:checked').value;
    gameState.settings.baseRate=parseInt(document.querySelector('input[name="baseRate"]:checked').value);
    gameState.settings.minFan=parseInt(document.getElementById('minFan').value);
    gameState.settings.maxFan=parseInt(document.getElementById('maxFan').value);
    gameState.settings.drawContinue=document.getElementById('drawContinue').checked;
    gameState.settings.baoPai=document.getElementById('baoPai').checked;
    for(let i=0;i<4;i++)playerProfiles[i].name=document.getElementById(`player${i}`).value||`ç©å®¶${i+1}`;
    saveProfiles();
    gameState.players=playerProfiles.map((p,i)=>({
        name:p.name,emoji:p.emoji,score:0,position:['æ±','å—','è¥¿','åŒ—'][i],
        wins:0,selfDraws:0,losses:0,totalFan:0,cheats:0
    }));
    gameState.currentDealer=0;gameState.roundNumber=1;gameState.consecutiveDealer=0;
    gameState.history=[];gameState.maxConsecutive=0;gameState.maxConsecutivePlayer='';
    gameState.startTime=new Date().toLocaleDateString('zh-HK');
    initStats(); startTimer(); showPage('gamePage'); updateGameDisplay(); updateUndoBtn(); saveGame();
}
function initStats(){
    gameState.stats={
        winKing:{player:'',count:0},selfDrawKing:{player:'',count:0},
        loserKing:{player:'',count:0},highestFan:{player:'',fan:0},cheatKing:{player:'',count:0}
    };
}

// â•â•â• éŠæˆ²é¡¯ç¤º â•â•â•
function updateGameDisplay(){
    const windNames=['æ±','å—','è¥¿','åŒ—'];
    const wr=Math.floor((gameState.roundNumber-1)/4);
    const wp=(gameState.roundNumber-1)%4;
    document.getElementById('currentRound').textContent=`${windNames[Math.min(wr,3)]}${['ä¸€','äºŒ','ä¸‰','å››'][wp]}å±€`;
    document.getElementById('roundCount').textContent=`ç¬¬ ${gameState.roundNumber} å±€`;
    const remaining=16-((gameState.roundNumber-1)%16);
    document.getElementById('remainingRounds').textContent=`è·å®Œæˆä¸€åœˆé‚„æœ‰ ${remaining} å±€`;
    const cel=document.getElementById('consecutiveInfo');
    if(gameState.consecutiveDealer>0){
        const p=gameState.players[gameState.currentDealer];
        cel.textContent=`ğŸ”¥ ${p.emoji||''} ${p.name} ${gameState.consecutiveDealer}é€£èŠï¼`;
        cel.style.display='block';
    } else cel.style.display='none';
    const grid=document.getElementById('playerGrid');
    grid.innerHTML='';
    gameState.players.forEach((player,index)=>{
        const isDealer=index===gameState.currentDealer;
        const sc=player.score>0?'positive':player.score<0?'negative':'';
        const card=document.createElement('div');
        card.className=`player-card ${isDealer?'dealer':''}`;
        card.innerHTML=`
            <div class="player-emoji">${player.emoji||'ğŸ˜€'}</div>
            <div class="player-position">${player.position}å®¶</div>
            <div class="player-name">${player.name}</div>
            <div class="player-score ${sc}">${player.score>=0?'+':''}$${player.score}</div>`;
        grid.appendChild(card);
    });
}

function showPage(pageId){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    const idx=['gamePage','fanTablePage','statsPage','historyPage','savedGamesPage','setupPage'].indexOf(pageId);
    if(idx!==-1)document.querySelectorAll('.nav-btn')[idx].classList.add('active');
    if(pageId==='statsPage')updateStats();
    if(pageId==='historyPage')updateHistory();
    if(pageId==='savedGamesPage')renderSavedGames();
    if(pageId==='setupPage')renderPlayerSetup();
}
function toggleCollapsible(header){
    const content=header.nextElementSibling;
    const arrow=header.querySelector('span:last-child');
    content.classList.toggle('open');
    arrow.textContent=content.classList.contains('open')?'â–²':'â–¼';
}
function saveGame(){
    const toSave={...gameState,timerAccumulated:getElapsedSeconds()};
    localStorage.setItem('mahjongGame',JSON.stringify(toSave));
}

// â•â•â• è¨˜éŒ„é£Ÿç³Šé é¢åˆå§‹åŒ– â•â•â•
function showRecordWin(){
    showPage('recordPage');
    const ws=document.getElementById('winnerSelect');
    ws.innerHTML='';
    // âœ… é£Ÿç³Šè€…ï¼šcheckbox å¤šé¸ï¼ˆä¸€ç‚®å¹¾éŸ¿ï¼‰
    gameState.players.forEach((player,index)=>{
        const o=document.createElement('div');
        o.className='multi-option';
        o.innerHTML=`
            <input type="checkbox" id="winner${index}" name="winner" value="${index}"
                onchange="onWinnerChange();">
            <label for="winner${index}">${player.emoji||''} ${player.name}<br><small>${player.position}å®¶</small></label>`;
        ws.appendChild(o);
    });
    document.getElementById('multiWinnerInfo').style.display='none';
    document.getElementById('selfDraw').checked=true;
    document.getElementById('loserSelectGroup').style.display='none';
    document.getElementById('cheatInfo').style.display='none';
    document.getElementById('fanSelectorWrapper').style.display='block';
    document.getElementById('hasBaoPai').checked=false;
    document.getElementById('baoPaiPersonSelect').style.display='none';
    document.getElementById('baoPaiSelectGroup').style.display=gameState.settings.baoPai?'block':'none';
    document.getElementById('modeSelect').checked=true;
    document.getElementById('fanSelectMode').style.display='block';
    document.getElementById('fanDirectMode').style.display='none';
    document.getElementById('directFanInput').value=gameState.settings.minFan;
    buildFanGroups(); updateTotalFan();
}

// âœ… é£Ÿç³Šè€…æ”¹è®Šæ™‚è§¸ç™¼
function onWinnerChange(){
    const checked=[...document.querySelectorAll('input[name="winner"]:checked')];
    const method=document.querySelector('input[name="winMethod"]:checked')?.value||'self';

    // âœ… è‡ªæ‘¸/è©ç³Šåªèƒ½é¸ä¸€äºº
    if((method==='self'||method==='cheat')&&checked.length>1){
        checked[checked.length-1].checked=false;
        alert('è‡ªæ‘¸ / è©ç³Šåªèƒ½é¸ä¸€ä½é£Ÿç³Šè€…ï¼');
        return;
    }

    const info=document.getElementById('multiWinnerInfo');
    if(checked.length>1&&method==='other'){
        info.style.display='block';
        info.innerHTML=`ğŸ”¥ <strong>ä¸€ç‚®å¹¾éŸ¿ï¼</strong> ${checked.length} äººåŒæ™‚é£Ÿç³Š<br><small>å‡ºéŠƒè€…é ˆè³ æ¯ä½é£Ÿç³Šè€…å„ä¸€ä»½å°åƒ¹</small>`;
    } else {
        info.style.display='none';
    }
    updateCheatInfo();
    updateLoserSelect();
    updateTotalFan();
}

function buildFanGroups(){
    const container=document.getElementById('fanGroupContainer');
    container.innerHTML='';
    const groups={};
    fanTypes.forEach((fan,index)=>{
        if(!groups[fan.value])groups[fan.value]=[];
        groups[fan.value].push({...fan,index});
    });
    Object.keys(groups).sort((a,b)=>a-b).forEach(fanValue=>{
        const items=groups[fanValue];
        const groupDiv=document.createElement('div');
        groupDiv.className='fan-group';
        const header=document.createElement('div');
        header.className='fan-group-header';
        header.innerHTML=`<span>${fanValue}ç•ªç•ªå‹</span><div style="display:flex;align-items:center;gap:9px;"><span class="group-badge">${items.length}ç¨®</span><span class="group-arrow">â–¶</span></div>`;
        header.addEventListener('click',()=>{
            const content=groupDiv.querySelector('.fan-group-content');
            const arrow=header.querySelector('.group-arrow');
            content.classList.toggle('open');
            arrow.textContent=content.classList.contains('open')?'â–¼':'â–¶';
        });
        const content=document.createElement('div');
        content.className='fan-group-content';
        items.forEach(fan=>{
            const item=document.createElement('div');
            item.className='fan-item';
            item.innerHTML=`
                <input type="checkbox" id="fan${fan.index}" value="${fan.value}" onchange="updateTotalFan()">
                <label for="fan${fan.index}" class="fan-label">
                    <span>${fan.name}</span><span class="fan-value">${fan.value}ç•ª</span>
                </label>`;
            item.addEventListener('click',function(e){
                if(e.target.tagName!=='INPUT'){
                    const cb=this.querySelector('input');cb.checked=!cb.checked;updateTotalFan();
                }
            });
            content.appendChild(item);
        });
        groupDiv.appendChild(header);groupDiv.appendChild(content);container.appendChild(groupDiv);
    });
}

function updateFanMode(){
    const mode=document.querySelector('input[name="fanMode"]:checked').value;
    document.getElementById('fanSelectMode').style.display=mode==='select'?'block':'none';
    document.getElementById('fanDirectMode').style.display=mode==='direct'?'block':'none';
    updateTotalFan();
}
function adjustDirectFan(delta){
    const input=document.getElementById('directFanInput');
    input.value=Math.max(0,Math.min(99,(parseInt(input.value)||0)+delta));
    updateTotalFan();
}

function updateWinMethod(){
    const method=document.querySelector('input[name="winMethod"]:checked').value;
    const checked=[...document.querySelectorAll('input[name="winner"]:checked')];
    const info=document.getElementById('multiWinnerInfo');
    if(method==='cheat'){
        document.getElementById('loserSelectGroup').style.display='none';
        document.getElementById('baoPaiSelectGroup').style.display='none';
        document.getElementById('fanSelectorWrapper').style.display='none';
        document.getElementById('cheatInfo').style.display='block';
        info.style.display='none';
        updateCheatInfo();
    } else {
        document.getElementById('fanSelectorWrapper').style.display='block';
        document.getElementById('cheatInfo').style.display='none';
        document.getElementById('loserSelectGroup').style.display=method==='other'?'block':'none';
        document.getElementById('baoPaiSelectGroup').style.display=gameState.settings.baoPai?'block':'none';
        // ä¸€ç‚®å¹¾éŸ¿æç¤ºåªå–ºå‡ºéŠƒæ¨¡å¼é¡¯ç¤º
        if(method==='other'&&checked.length>1){
            info.style.display='block';
            info.innerHTML=`ğŸ”¥ <strong>ä¸€ç‚®å¹¾éŸ¿ï¼</strong> ${checked.length} äººåŒæ™‚é£Ÿç³Š<br><small>å‡ºéŠƒè€…é ˆè³ æ¯ä½é£Ÿç³Šè€…å„ä¸€ä»½å°åƒ¹</small>`;
        } else {
            info.style.display='none';
        }
        if(method==='other')updateLoserSelect();
    }
    updateTotalFan();
}

// âœ… å‡ºéŠƒè€…ï¼šå–®é¸ radioï¼Œæ’é™¤å·²é¸é£Ÿç³Šè€…
function updateLoserSelect(){
    const ls=document.getElementById('loserSelect');
    ls.innerHTML='';
    const winnerIndexes=[...document.querySelectorAll('input[name="winner"]:checked')].map(cb=>parseInt(cb.value));
    let first=true;
    gameState.players.forEach((player,index)=>{
        if(!winnerIndexes.includes(index)){
            const o=document.createElement('div');
            o.className='radio-option';
            o.innerHTML=`
                <input type="radio" id="loser${index}" name="loser" value="${index}" ${first?'checked':''}>
                <label for="loser${index}">${player.emoji||''} ${player.name}<br><small>${player.position}å®¶</small></label>`;
            ls.appendChild(o);
            first=false;
        }
    });
    updateBaoPaiSelect();
}

function updateBaoPai(){
    const has=document.getElementById('hasBaoPai').checked;
    document.getElementById('baoPaiPersonSelect').style.display=has?'block':'none';
    if(has)updateBaoPaiSelect();
}
function updateBaoPaiSelect(){
    const container=document.getElementById('baoPaiPersonSelect');
    container.innerHTML='';
    const winnerIndexes=[...document.querySelectorAll('input[name="winner"]:checked')].map(cb=>parseInt(cb.value));
    let first=true;
    gameState.players.forEach((player,index)=>{
        if(!winnerIndexes.includes(index)){
            const o=document.createElement('div');
            o.className='radio-option';
            o.innerHTML=`
                <input type="radio" id="baoPaiPerson${index}" name="baoPaiPerson" value="${index}" ${first?'checked':''}>
                <label for="baoPaiPerson${index}">${player.emoji||''} ${player.name}<br><small>${player.position}å®¶</small></label>`;
            container.appendChild(o);first=false;
        }
    });
}

function updateCheatInfo(){
    const checked=[...document.querySelectorAll('input[name="winner"]:checked')];
    if(checked.length===0)return;
    const p=gameState.players[parseInt(checked[0].value)];
    const m=calculateMoney(gameState.settings.maxFan);
    document.getElementById('cheatInfoText').innerHTML=`
        <div style="color:#555;margin-bottom:9px;">
            <strong>${p.emoji||''} ${p.name}</strong> è©ç³Šï¼Œé ˆè³ å…¶ä»–ä¸‰å®¶<br>
            æ¯å®¶ï¼š<strong>$${m}</strong>ï¼ˆ${gameState.settings.maxFan}ç•ªä¸Šé™ï¼‰
        </div>
        <div class="cheat-penalty">å…±è³ ï¼š$${m*3}</div>`;
}

function updateTotalFan(){
    const mode=document.querySelector('input[name="fanMode"]:checked')?.value||'select';
    let totalFan=0;
    if(mode==='direct'){
        totalFan=parseInt(document.getElementById('directFanInput').value)||0;
    } else {
        document.querySelectorAll('.fan-item').forEach(item=>{
            const cb=item.querySelector('input[type="checkbox"]');
            if(cb.checked){totalFan+=parseInt(cb.value);item.classList.add('checked');}
            else item.classList.remove('checked');
        });
    }
    const actual=Math.min(totalFan,gameState.settings.maxFan);
    const baseMoney=calculateMoney(actual);
    const method=document.querySelector('input[name="winMethod"]:checked')?.value||'self';
    const winnerCount=[...document.querySelectorAll('input[name="winner"]:checked')].length;
    // ä¸€ç‚®å¹¾éŸ¿ï¼šå‡ºéŠƒè€…è³  baseMoney Ã— é£Ÿç³Šäººæ•¸
    const totalWin=method==='other'&&winnerCount>1?baseMoney*winnerCount:baseMoney;
    document.getElementById('totalFanDisplay').textContent=`${totalFan} ç•ª`;
    if(method==='other'&&winnerCount>1){
        document.getElementById('totalMoneyDisplay').textContent=`å‡ºéŠƒè€…å…±è³  $${totalWin}ï¼ˆ${winnerCount}Ã—$${baseMoney}ï¼‰`;
    } else {
        document.getElementById('totalMoneyDisplay').textContent=`å°åƒ¹ $${baseMoney}`;
    }
    const cap=document.getElementById('capMessage');
    if(totalFan>gameState.settings.maxFan){cap.textContent=`å·²çˆ†æ£šï¼è¨ˆ ${gameState.settings.maxFan} ç•ª`;cap.style.color='#dc2626';}
    else if(totalFan>0&&totalFan<gameState.settings.minFan){cap.textContent=`æœªé”èµ·ç³Šç•ªæ•¸ï¼ˆéœ€ ${gameState.settings.minFan} ç•ªï¼‰`;cap.style.color='#dc2626';}
    else cap.textContent='';
}

function calculateMoney(fan){
    const base=gameState.settings.baseRate;
    if(fan===0)return base;
    if(gameState.settings.spicyLevel==='full')return base*Math.pow(2,fan);
    if(fan<=4)return base*Math.pow(2,fan);
    if(fan%2===0)return base*Math.pow(2,4)*Math.pow(2,(fan-4)/2);
    return Math.round(base*Math.pow(2,4)*Math.pow(2,(fan-5)/2)*1.5);
}

// â•â•â• ç¢ºèªé£Ÿç³Š â•â•â•
function confirmWin(){
    const winnerChecked=[...document.querySelectorAll('input[name="winner"]:checked')];
    if(winnerChecked.length===0){alert('è«‹é¸æ“‡é£Ÿç³Šè€…ï¼');return;}
    const winnerIndexes=winnerChecked.map(cb=>parseInt(cb.value));
    const method=document.querySelector('input[name="winMethod"]:checked').value;
    const isMultiWinner=winnerIndexes.length>1;

    // â•â•â• è©ç³Šï¼ˆåªå–ç¬¬ä¸€å€‹é£Ÿç³Šè€…ï¼‰â•â•â•
    if(method==='cheat'){
        const wi=winnerIndexes[0];
        const cm=calculateMoney(gameState.settings.maxFan);
        const sc={};gameState.players.forEach((_,i)=>sc[i]=0);
        gameState.players.forEach((_,i)=>{if(i!==wi){sc[i]=cm;sc[wi]-=cm;}});
        Object.keys(sc).forEach(i=>{gameState.players[i].score+=sc[i];});
        gameState.players[wi].cheats=(gameState.players[wi].cheats||0)+1;
        gameState.history.push({
            round:gameState.roundNumber,roundName:document.getElementById('currentRound').textContent,
            winner:wi,method:'cheat',fans:['è©ç³Š'],totalFan:0,actualFan:0,
            money:sc[wi],scoreChanges:sc,timestamp:new Date().toLocaleTimeString('zh-HK')
        });
        updateGameStats();
        gameState.currentDealer=(gameState.currentDealer+1)%4;gameState.consecutiveDealer=0;
        gameState.roundNumber++;updateGameDisplay();updateUndoBtn();saveGame();showPage('gamePage');return;
    }

    // â•â•â• ç•ªæ•¸ â•â•â•
    const fanMode=document.querySelector('input[name="fanMode"]:checked')?.value||'select';
    let totalFan=0;const selectedFans=[];
    if(fanMode==='direct'){
        totalFan=parseInt(document.getElementById('directFanInput').value)||0;
        selectedFans.push(`è‡ªè¨‚ ${totalFan}ç•ª`);
    } else {
        document.querySelectorAll('.fan-item input[type="checkbox"]:checked').forEach(cb=>{
            totalFan+=parseInt(cb.value);
            selectedFans.push(cb.parentElement.querySelector('.fan-label span').textContent);
        });
    }
    if(totalFan<gameState.settings.minFan){alert(`æœªé”èµ·ç³Šç•ªæ•¸ï¼éœ€è¦è‡³å°‘ ${gameState.settings.minFan} ç•ªã€‚`);return;}
    const actualFan=Math.min(totalFan,gameState.settings.maxFan);
    const baseMoney=calculateMoney(actualFan);
    const sc={};gameState.players.forEach((_,i)=>sc[i]=0);
    const hasBaoPai=gameState.settings.baoPai&&document.getElementById('hasBaoPai').checked;
    let baoPaiPerson=-1,loserIndex=-1;

    if(method==='self'){
        // è‡ªæ‘¸ï¼šä¸‰å®¶å„ä»˜å°åƒ¹ï¼Œå¤šå€‹é£Ÿç³Šè€…ä¸é©ç”¨ï¼ˆè‡ªæ‘¸åªèƒ½1äººï¼‰
        const wi=winnerIndexes[0];
        if(hasBaoPai){
            baoPaiPerson=parseInt(document.querySelector('input[name="baoPaiPerson"]:checked').value);
            sc[baoPaiPerson]=-(baseMoney*3);sc[wi]=baseMoney*3;
        } else {
            gameState.players.forEach((_,i)=>{if(i!==wi){sc[i]=-baseMoney;sc[wi]+=baseMoney;}});
        }
        gameState.players[wi].wins++;
        gameState.players[wi].selfDraws++;
        gameState.players[wi].totalFan+=totalFan;
    } else {
        // âœ… å‡ºéŠƒï¼šä¸€ç‚®å¹¾éŸ¿ï¼Œä¸€å€‹å‡ºéŠƒè€…è³ å¤šå€‹é£Ÿç³Šè€…
        loserIndex=parseInt(document.querySelector('input[name="loser"]:checked').value);
        gameState.players[loserIndex].losses++;
        winnerIndexes.forEach(wi=>{
            sc[loserIndex]-=baseMoney;
            sc[wi]+=baseMoney;
            gameState.players[wi].wins++;
            gameState.players[wi].totalFan+=totalFan;
        });
    }

    Object.keys(sc).forEach(i=>{gameState.players[i].score+=sc[i];});

    gameState.history.push({
        round:gameState.roundNumber,roundName:document.getElementById('currentRound').textContent,
        winners:winnerIndexes,loser:loserIndex,method,fans:selectedFans,totalFan,actualFan,baseMoney,
        money:sc[winnerIndexes[0]],scoreChanges:sc,
        timestamp:new Date().toLocaleTimeString('zh-HK'),
        baoPai:hasBaoPai,baoPaiPerson,fanMode,isMultiWinner
    });

    updateGameStats();
    // æ…¶ç¥ï¼ˆä»»ä½•ä¸€ä½é£Ÿç³Šè€…é«˜ç•ªï¼‰
    if(actualFan>=10)showCelebration(
        isMultiWinner?`ä¸€ç‚®å¹¾éŸ¿ğŸ”¥`:gameState.players[winnerIndexes[0]].name,
        selectedFans.join('ã€'),sc[winnerIndexes[0]]
    );
    // èŠå®¶åˆ¤æ–·ï¼šå…¶ä¸­ä¸€ä½é£Ÿç³Šè€…ä¿‚èŠå®¶å°±é€£èŠ
    if(winnerIndexes.includes(gameState.currentDealer)){gameState.consecutiveDealer++;}
    else{gameState.currentDealer=(gameState.currentDealer+1)%4;gameState.consecutiveDealer=0;}
    gameState.roundNumber++;updateGameDisplay();updateUndoBtn();saveGame();
    if(actualFan<10)showPage('gamePage');
}

function cancelRecord(){showPage('gamePage');}

function recordDraw(){
    if(!confirm('ç¢ºèªæµå±€ï¼Ÿ'))return;
    gameState.history.push({
        round:gameState.roundNumber,roundName:document.getElementById('currentRound').textContent,
        winner:-1,method:'draw',timestamp:new Date().toLocaleTimeString('zh-HK')
    });
    if(!gameState.settings.drawContinue){gameState.currentDealer=(gameState.currentDealer+1)%4;gameState.consecutiveDealer=0;}
    gameState.roundNumber++;updateGameDisplay();updateUndoBtn();saveGame();
}

// â•â•â• æ‚”æ£‹ â•â•â•
function undoLastRecord(){
    if(gameState.history.length===0)return;
    if(!confirm('ç¢ºèªæ’¤éŠ·ä¸Šä¸€å±€è¨˜éŒ„ï¼Ÿ'))return;
    const last=gameState.history[gameState.history.length-1];
    if(last.scoreChanges)Object.keys(last.scoreChanges).forEach(i=>{gameState.players[i].score-=last.scoreChanges[i];});
    if(last.method==='cheat'){
        gameState.players[last.winner].cheats=Math.max(0,(gameState.players[last.winner].cheats||0)-1);
    } else if(last.method!=='draw'){
        // é‚„åŸé£Ÿç³Šè€…çµ±è¨ˆ
        const winners=last.winners||[last.winner];
        winners.forEach(wi=>{
            gameState.players[wi].wins=Math.max(0,gameState.players[wi].wins-1);
            gameState.players[wi].totalFan=Math.max(0,gameState.players[wi].totalFan-(last.totalFan||0));
        });
        if(last.method==='self'){
            gameState.players[winners[0]].selfDraws=Math.max(0,gameState.players[winners[0]].selfDraws-1);
        }
        if(last.loser!==-1&&last.loser!==undefined){
            gameState.players[last.loser].losses=Math.max(0,gameState.players[last.loser].losses-1);
        }
    }
    gameState.history.pop();
    gameState.roundNumber=Math.max(1,gameState.roundNumber-1);
    recalcDealerFromHistory();updateGameStats();updateGameDisplay();updateUndoBtn();saveGame();
}

function recalcDealerFromHistory(){
    let dealer=0,consec=0;
    let maxC=0,maxP=''; // âœ… é‡æ–°å¾é ­è¨ˆç®—ï¼Œå””ç”¨èˆŠå€¼
    gameState.history.forEach(h=>{
        if(h.method==='draw'){
            if(!gameState.settings.drawContinue){dealer=(dealer+1)%4;consec=0;}
        } else if(h.method==='cheat'){
            dealer=(dealer+1)%4;consec=0;
        } else {
            const winners=h.winners||[h.winner];
            if(winners.includes(dealer)){
                consec++;
                if(consec>maxC){maxC=consec;maxP=gameState.players[dealer].name;}
            } else {dealer=(dealer+1)%4;consec=0;}
        }
    });
    gameState.currentDealer=dealer;
    gameState.consecutiveDealer=consec;
    gameState.maxConsecutive=maxC;       // âœ… æ‚”æ£‹å¾Œæ­£ç¢ºæ›´æ–°
    gameState.maxConsecutivePlayer=maxP;
}
function updateUndoBtn(){
    document.getElementById('undoBtn').style.display=gameState.history.length>0?'inline-flex':'none';
}

// â•â•â• çµ±è¨ˆ â•â•â•
function updateGameStats(){
    let mW=0,wK='',mS=0,sK='',mL=0,lK='',mC=0,cK='',hF=0,hP='';
    gameState.players.forEach(p=>{
        if(p.wins>mW){mW=p.wins;wK=p.name;}
        if(p.selfDraws>mS){mS=p.selfDraws;sK=p.name;}
        if(p.losses>mL){mL=p.losses;lK=p.name;}
        if((p.cheats||0)>mC){mC=p.cheats||0;cK=p.name;}
    });
    gameState.history.forEach(h=>{
        if(h.method!=='cheat'&&h.method!=='draw'&&h.totalFan>hF){
            hF=h.totalFan;
            const winners=h.winners||[h.winner];
            hP=gameState.players[winners[0]].name;
        }
    });
    let td=0,tc=0;
    gameState.history.forEach(h=>{
        if(h.method==='draw'){if(!gameState.settings.drawContinue){td=(td+1)%4;tc=0;}}
        else if(h.method==='cheat'){td=(td+1)%4;tc=0;}
        else{
            const winners=h.winners||[h.winner];
            if(winners.includes(td)){tc++;if(tc>(gameState.maxConsecutive||0)){gameState.maxConsecutive=tc;gameState.maxConsecutivePlayer=gameState.players[td].name;}}
            else{td=(td+1)%4;tc=0;}
        }
    });
    gameState.stats={
        winKing:{player:wK,count:mW},selfDrawKing:{player:sK,count:mS},
        loserKing:{player:lK,count:mL},highestFan:{player:hP,fan:hF},cheatKing:{player:cK,count:mC}
    };
}

function updateStats(){
    const s=gameState.stats;
    document.getElementById('winKing').textContent=s.winKing?.player?`${s.winKing.player} (${s.winKing.count}æ¬¡)`:'-';
    document.getElementById('selfDrawKing').textContent=s.selfDrawKing?.player?`${s.selfDrawKing.player} (${s.selfDrawKing.count}æ¬¡)`:'-';
    document.getElementById('loserKing').textContent=s.loserKing?.player?`${s.loserKing.player} (${s.loserKing.count}æ¬¡)`:'-';
    document.getElementById('highestFan').textContent=s.highestFan?.player?`${s.highestFan.player} (${s.highestFan.fan}ç•ª)`:'-';
    document.getElementById('cheatKing').textContent=s.cheatKing?.player?`${s.cheatKing.player} (${s.cheatKing.count}æ¬¡)`:'-';
    document.getElementById('maxConsecutiveStat').textContent=gameState.maxConsecutive>0?`${gameState.maxConsecutivePlayer} (${gameState.maxConsecutive}é€£)`:'-';
    const tbody=document.getElementById('statsTableBody');
    tbody.innerHTML='';
    gameState.players.forEach(p=>{
        const avg=p.wins>0?(p.totalFan/p.wins).toFixed(1):'0.0';
        const sc=p.score>0?'positive':p.score<0?'negative':'';
        const row=document.createElement('tr');
        row.innerHTML=`
            <td>${p.emoji||''} ${p.name}</td>
            <td class="table-center ${sc}"><strong>${p.score>=0?'+':''}$${p.score}</strong></td>
            <td class="table-center">${p.wins}</td>
            <td class="table-center">${p.selfDraws}</td>
            <td class="table-center">${p.losses}</td>
            <td class="table-center" style="color:${(p.cheats||0)>0?'#dc2626':'#555'}">${p.cheats||0}</td>
            <td class="table-center">${avg}</td>`;
        tbody.appendChild(row);
    });
    const fanCount={};
    gameState.history.forEach(h=>{
        if(h.method!=='cheat'&&h.method!=='draw'&&h.fans){
            h.fans.forEach(f=>{if(!f.startsWith('è‡ªè¨‚'))fanCount[f]=(fanCount[f]||0)+1;});
        }
    });
    const ranking=Object.entries(fanCount).sort((a,b)=>b[1]-a[1]).slice(0,8);
    const medals=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4ï¸âƒ£','5ï¸âƒ£','6ï¸âƒ£','7ï¸âƒ£','8ï¸âƒ£'];
    document.getElementById('fanStatsBody').innerHTML=ranking.length===0
        ?'<tr><td colspan="2" style="text-align:center;color:#999;">æš«ç„¡æ•¸æ“š</td></tr>'
        :ranking.map(([name,count],i)=>`<tr><td>${medals[i]} ${name}</td><td class="table-center"><strong>${count}</strong> æ¬¡</td></tr>`).join('');
}

// â•â•â• æœ¬å±€è¨˜éŒ„ â•â•â•
function updateHistory(){
    const list=document.getElementById('historyList');
    if(gameState.history.length===0){list.innerHTML='<p style="text-align:center;color:#999;padding:40px;">æš«ç„¡è¨˜éŒ„</p>';return;}
    list.innerHTML='';
    gameState.history.slice().reverse().forEach(record=>{
        const item=document.createElement('div');
        item.className='history-item';
        if(record.method==='draw'){
            item.innerHTML=`<div class="history-header"><span>ç¬¬${record.round}å±€ï¼ˆ${record.roundName}ï¼‰</span><span>${record.timestamp}</span></div><div class="history-details"><strong>æµå±€</strong></div>`;
        } else if(record.method==='cheat'){
            item.classList.add('cheat-record');
            const cheater=gameState.players[record.winner];
            const cm=calculateMoney(gameState.settings.maxFan);
            let md='<div class="history-money">';
            Object.keys(record.scoreChanges).forEach(i=>{
                const ch=record.scoreChanges[i];
                if(ch!==0){const p=gameState.players[i];md+=`<div style="color:${ch>0?'#059669':'#dc2626'};">${p.emoji||''} ${p.name}: ${ch>0?'+':''}$${ch}</div>`;}
            });
            md+='</div>';
            item.innerHTML=`<div class="history-header"><span>ç¬¬${record.round}å±€ï¼ˆ${record.roundName}ï¼‰</span><span>${record.timestamp}</span></div>
            <div class="history-details"><strong style="color:#dc2626;">âŒ ${cheater.emoji||''} ${cheater.name} è©ç³Šï¼</strong>
            <div>ç½°æ¬¾ï¼šæ¯å®¶ $${cm}ï¼Œå…±è³  <strong>$${-record.money}</strong></div></div>${md}`;
        } else {
            const winners=record.winners||[record.winner];
            const isMulti=record.isMultiWinner&&winners.length>1;
            if(isMulti)item.classList.add('multi-win');
            const fi=record.actualFan>=10?' ğŸŒŸ':'';
            const mt=record.method==='self'?'è‡ªæ‘¸':isMulti?`ä¸€ç‚®å¹¾éŸ¿ğŸ”¥ (${winners.length}äººé£Ÿç³Š)`:'å‡ºéŠƒ';
            let md='<div class="history-money">';
            Object.keys(record.scoreChanges).forEach(i=>{
                const ch=record.scoreChanges[i];
                if(ch!==0){const p=gameState.players[i];md+=`<div style="color:${ch>0?'#059669':'#dc2626'};">${p.emoji||''} ${p.name}: ${ch>0?'+':''}$${ch}</div>`;}
            });
            md+='</div>';
            let bp='';
            if(record.baoPai&&record.baoPaiPerson!==-1&&record.baoPaiPerson!==undefined){
                bp=`<div style="color:#f59e0b;margin-top:3px;">âš ï¸ ${gameState.players[record.baoPaiPerson].emoji||''} ${gameState.players[record.baoPaiPerson].name} åŒ…ç‰Œ</div>`;
            }
            const winnerNames=winners.map(wi=>`${gameState.players[wi].emoji||''} ${gameState.players[wi].name}`).join('ã€');
            let loserInfo='';
            if(record.method==='other'&&record.loser!==-1){
                loserInfo=`<div style="color:#dc2626;margin-top:3px;">ğŸ’¥ å‡ºéŠƒï¼š${gameState.players[record.loser].emoji||''} ${gameState.players[record.loser].name}</div>`;
            }
            const fl=record.totalFan!==record.actualFan
                ?`${record.totalFan}ç•ª <span style="color:#dc2626;">âš ï¸ çˆ†æ£š${record.actualFan}ç•ª</span> = $${record.money}`
                :`${record.totalFan}ç•ª = $${record.money}`;
            item.innerHTML=`
                <div class="history-header"><span>ç¬¬${record.round}å±€ï¼ˆ${record.roundName}ï¼‰${fi}</span><span>${record.timestamp}</span></div>
                <div class="history-details">
                    <div><strong>ğŸ¯ ${winnerNames}</strong>ï¼ˆ${mt}ï¼‰</div>
                    <div>ğŸ“ ${record.fans.join('ã€')}</div>
                    <div>ğŸ’° ${fl}</div>
                    ${loserInfo}${bp}
                </div>${md}`;
        }
        list.appendChild(item);
    });
}

// â•â•â• æ…¶ç¥ & çµç®— â•â•â•
function showCelebration(playerName,fanType,money){
    document.getElementById('celebrationFanType').textContent=`${playerName} - ${fanType}`;
    document.getElementById('celebrationMoney').textContent=`+$${money}`;
    document.getElementById('celebration').classList.add('active');
    setTimeout(()=>document.getElementById('celebration').classList.remove('active'),5000);
}
function closeCelebration(){document.getElementById('celebration').classList.remove('active');showPage('gamePage');}

function endGame(){
    if(!confirm('ç¢ºèªçµæŸç‰Œå±€ä¸¦æŸ¥çœ‹æ‰¾æ•¸æ–¹æ¡ˆï¼Ÿ'))return;
    stopTimer(); saveCompletedGame(); showSettlement();
    localStorage.removeItem('mahjongGame');
}

function showSettlement(){
    const elapsed=timerAccumulated;
    const content=document.getElementById('settlementContent');
    let html='';
    if(elapsed>0){
        html+=`<div class="duration-badge">â±ï¸ æœ¬å±€æ­·æ™‚ï¼š<strong>${formatDuration(elapsed)}</strong></div><br>`;
    }
    html+='<h3 style="color:var(--mahjong-green);margin-bottom:11px;">ğŸ† æœ€çµ‚æˆ°ç¸¾</h3>';
    html+='<table class="table" style="margin-bottom:18px;"><thead><tr><th>ç©å®¶</th><th class="table-center">é‡‘é¡</th></tr></thead><tbody>';
    gameState.players.forEach(p=>{
        const sc=p.score>0?'#059669':p.score<0?'#dc2626':'#333';
        html+=`<tr><td style="color:#333;">${p.emoji||''} ${p.name}</td><td class="table-center"><strong style="color:${sc};">${p.score>=0?'+':''}$${p.score}</strong></td></tr>`;
    });
    html+='</tbody></table>';
    const settles=calcSettlement(gameState.players.map(p=>({name:(p.emoji||'')+' '+p.name,score:p.score})));
    html+='<h3 style="color:var(--mahjong-green);margin-bottom:11px;">ğŸ’¸ æ‰¾æ•¸æ–¹æ¡ˆ</h3>';
    if(settles.length===0){
        html+='<p style="text-align:center;color:#059669;font-weight:bold;padding:15px;">ğŸ‰ å¤§å®¶æ‰“å’Œï¼Œç„¡éœ€æ‰¾æ•¸ï¼</p>';
    } else {
        settles.forEach((s,i)=>{
            html+=`<div class="settlement-item" id="settle${i}">
                <span style="color:#333;font-size:0.95rem;">
                    ${i+1}. <strong style="color:#333;">${s.from}</strong>
                    ä¿¾ <strong style="color:#dc2626;font-size:1.1rem;">$${s.amount}</strong>
                    ä¿¾ <strong style="color:#059669;">${s.to}</strong>
                </span>
                <input type="checkbox" style="width:24px;height:24px;cursor:pointer;accent-color:#1a5d3a;" onchange="toggleSettled(${i})">
            </div>`;
        });
    }
    content.innerHTML=html;
    document.getElementById('settlementModal').classList.add('active');
}

function calcSettlement(players){
    const pos=[],neg=[];
    players.forEach(p=>{if(p.score>0)pos.push({name:p.name,amount:p.score});else if(p.score<0)neg.push({name:p.name,amount:-p.score});});
    pos.sort((a,b)=>b.amount-a.amount);neg.sort((a,b)=>b.amount-a.amount);
    const res=[];let i=0,j=0;
    while(i<pos.length&&j<neg.length){
        const pay=Math.min(pos[i].amount,neg[j].amount);
        res.push({from:neg[j].name,to:pos[i].name,amount:pay});
        pos[i].amount-=pay;neg[j].amount-=pay;
        if(pos[i].amount===0)i++;if(neg[j].amount===0)j++;
    }
    return res;
}
function toggleSettled(idx){document.getElementById(`settle${idx}`).classList.toggle('completed');}

function closeSettlement(){
    document.getElementById('settlementModal').classList.remove('active');
    const savedSettings={...gameState.settings};
    gameState={
        settings:savedSettings,players:[],currentDealer:0,roundNumber:1,consecutiveDealer:0,
        history:[],stats:{},maxConsecutive:0,maxConsecutivePlayer:'',startTime:null
    };
    resetTimer();
    showPage('setupPage');
}

// â•â•â• æ­·å²ç‰Œå±€ â•â•â•
function saveCompletedGame(){
    const games=JSON.parse(localStorage.getItem('mahjongHistory')||'[]');
    games.unshift({
        date:gameState.startTime||new Date().toLocaleDateString('zh-HK'),
        endTime:new Date().toLocaleTimeString('zh-HK'),
        totalRounds:gameState.roundNumber-1,
        settings:{...gameState.settings},
        players:gameState.players.map(p=>({name:p.name,emoji:p.emoji,score:p.score,wins:p.wins,selfDraws:p.selfDraws,losses:p.losses,cheats:p.cheats||0})),
        history:gameState.history,
        maxConsecutive:gameState.maxConsecutive,
        maxConsecutivePlayer:gameState.maxConsecutivePlayer,
        duration:timerAccumulated,
        durationText:timerAccumulated>0?formatDuration(timerAccumulated):null
    });
    if(games.length>MAX_SAVED_GAMES)games.splice(MAX_SAVED_GAMES);
    localStorage.setItem('mahjongHistory',JSON.stringify(games));
}

function renderSavedGames(){
    const games=JSON.parse(localStorage.getItem('mahjongHistory')||'[]');
    const container=document.getElementById('savedGamesList');
    if(games.length===0){container.innerHTML='<p style="text-align:center;color:#999;padding:40px;">æš«ç„¡æ­·å²è¨˜éŒ„<br><small>å®Œæˆç‰Œå±€å¾Œè‡ªå‹•å„²å­˜</small></p>';return;}
    container.innerHTML='';
    games.forEach((game,index)=>{
        const sorted=[...game.players].sort((a,b)=>b.score-a.score);
        const winner=sorted[0];
        const spicyLabel=game.settings.spicyLevel==='full'?'ğŸ”¥ğŸ”¥è¾£è¾£ä¸Š':'ğŸŒ¶ï¸åŠè¾£ä¸Š';
        const baseLabel=['','äºŒäº”é›','äº”ä¸€','','ä¸€äºŒèšŠ'][game.settings.baseRate]||'';
        const card=document.createElement('div');
        card.className='saved-game-card';
        card.innerHTML=`
            <div class="saved-game-header">
                <span style="font-size:0.95rem;color:var(--mahjong-green-dark);">ğŸ“… ${game.date} ${game.endTime||''}</span>
                <button class="delete-game-btn" onclick="deleteSavedGame(${index},event)">ğŸ—‘ï¸</button>
            </div>
            <div style="font-size:0.85rem;color:#666;margin-bottom:6px;">
                ${spicyLabel} Â· ${baseLabel} Â· ${game.totalRounds}å±€
                ${game.durationText?` Â· â±ï¸ ${game.durationText}`:''}
            </div>
            <div style="font-size:0.88rem;color:#555;margin-bottom:6px;">
                ğŸ† ${winner.emoji||''} ${winner.name} å‹å‡ºï¼ˆ${winner.score>=0?'+':''}$${winner.score}ï¼‰
                ${game.maxConsecutive>0?` Â· ğŸ‘‘ æœ€é•·é€£èŠ ${game.maxConsecutive} æ¬¡`:''}
            </div>
            <div class="saved-game-players">
                ${game.players.map(p=>{
                    const sc=p.score>0?'#059669':p.score<0?'#dc2626':'#555';
                    return `<div class="saved-game-player"><span>${p.emoji||''} ${p.name}</span><strong style="color:${sc};">${p.score>=0?'+':''}$${p.score}</strong></div>`;
                }).join('')}
            </div>`;
        card.addEventListener('click',()=>openSavedGame(index));
        container.appendChild(card);
    });
}

function deleteSavedGame(index,event){
    event.stopPropagation();
    if(!confirm('ç¢ºèªåˆªé™¤æ­¤ç‰Œå±€è¨˜éŒ„ï¼Ÿ'))return;
    const games=JSON.parse(localStorage.getItem('mahjongHistory')||'[]');
    games.splice(index,1);
    localStorage.setItem('mahjongHistory',JSON.stringify(games));
    renderSavedGames();
}

function openSavedGame(index){
    const games=JSON.parse(localStorage.getItem('mahjongHistory')||'[]');
    const game=games[index];
    document.getElementById('savedGameModalTitle').textContent=`ğŸ“… ${game.date} ç‰Œå±€è©³æƒ…`;
    const spicyLabel=game.settings.spicyLevel==='full'?'ğŸ”¥ğŸ”¥è¾£è¾£ä¸Š':'ğŸŒ¶ï¸åŠè¾£ä¸Š';
    const baseLabel=['','äºŒäº”é›($1)','äº”ä¸€($2)','','ä¸€äºŒèšŠ($4)'][game.settings.baseRate]||'';
    let html='';
    if(game.duration&&game.duration>0){
        html+=`<div class="duration-badge">â±ï¸ éŠæˆ²æ™‚é–“ï¼š<strong>${game.durationText}</strong></div><br>`;
    }
    html+=`<div style="background:rgba(42,157,143,0.08);padding:11px 14px;border-radius:8px;margin-bottom:14px;font-size:0.88rem;color:#555;">
        ${spicyLabel} Â· ${baseLabel} Â· èµ·ç³Š${game.settings.minFan}ç•ª Â· çˆ†æ£š${game.settings.maxFan}ç•ª Â· å…±${game.totalRounds}å±€
        ${game.maxConsecutive>0?` Â· ğŸ‘‘ æœ€é•·é€£èŠ ${game.maxConsecutive} æ¬¡ï¼ˆ${game.maxConsecutivePlayer}ï¼‰`:''}
    </div>`;
    const sorted=[...game.players].sort((a,b)=>b.score-a.score);
    html+='<h4 style="color:var(--mahjong-green);margin-bottom:9px;">ğŸ† æœ€çµ‚æˆ°ç¸¾</h4>';
    html+='<table class="table" style="margin-bottom:16px;"><thead><tr><th>æ’å</th><th>ç©å®¶</th><th class="table-center">é‡‘é¡</th><th class="table-center">é£Ÿç³Š</th><th class="table-center">è‡ªæ‘¸</th><th class="table-center">å‡ºéŠƒ</th></tr></thead><tbody>';
    const medals=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4ï¸âƒ£'];
    sorted.forEach((p,i)=>{
        const sc=p.score>0?'#059669':p.score<0?'#dc2626':'#333';
        html+=`<tr><td>${medals[i]}</td><td style="color:#333;">${p.emoji||''} ${p.name}</td><td class="table-center"><strong style="color:${sc};">${p.score>=0?'+':''}$${p.score}</strong></td><td class="table-center">${p.wins}</td><td class="table-center">${p.selfDraws}</td><td class="table-center">${p.losses}</td></tr>`;
    });
    html+='</tbody></table>';
    html+=`<h4 style="color:var(--mahjong-green);margin-bottom:9px;">ğŸ“ˆ é‡‘é¡èµ°å‹¢</h4>
    <div class="chart-container">
        <div class="chart-legend" id="chartLegend_${index}"></div>
        <canvas id="scoreChart_${index}" height="220"></canvas>
    </div>`;
    document.getElementById('savedGameModalContent').innerHTML=html;
    document.getElementById('savedGameModal').classList.add('active');
    setTimeout(()=>drawScoreChart(game,index),100);
}

function drawScoreChart(game,index){
    const canvas=document.getElementById(`scoreChart_${index}`);
    if(!canvas)return;
    const ctx=canvas.getContext('2d');
    const dpr=window.devicePixelRatio||1;
    const W=canvas.parentElement.clientWidth-30,H=220;
    canvas.width=W*dpr;canvas.height=H*dpr;
    canvas.style.width=W+'px';canvas.style.height=H+'px';
    ctx.scale(dpr,dpr);
    const scores=game.players.map(()=>[0]);
    const cumulative=game.players.map(()=>0);
    game.history.forEach(h=>{
        if(h.scoreChanges){
            game.players.forEach((_,i)=>{cumulative[i]+=(h.scoreChanges[i]||0);scores[i].push(cumulative[i]);});
        } else {
            game.players.forEach((_,i)=>scores[i].push(cumulative[i]));
        }
    });
    const allVals=scores.flat();
    const minVal=Math.min(...allVals),maxVal=Math.max(...allVals);
    const range=Math.max(maxVal-minVal,1);
    const PAD={top:20,right:15,bottom:35,left:55};
    const CW=W-PAD.left-PAD.right,CH=H-PAD.top-PAD.bottom;
    const xStep=scores[0].length>1?CW/(scores[0].length-1):CW;
    function toX(i){return PAD.left+(scores[0].length>1?i*xStep:CW/2);}
    function toY(v){return PAD.top+CH-(((v-minVal)/range)*CH);}
    ctx.fillStyle='#fff';ctx.fillRect(0,0,W,H);
    ctx.strokeStyle='#e5e7eb';ctx.lineWidth=1;
    for(let g=0;g<=5;g++){
        const y=PAD.top+(g/5)*CH;
        ctx.beginPath();ctx.moveTo(PAD.left,y);ctx.lineTo(W-PAD.right,y);ctx.stroke();
        const val=maxVal-((maxVal-minVal)*g/5);
        ctx.fillStyle='#9ca3af';ctx.font='11px sans-serif';ctx.textAlign='right';
        ctx.fillText(`$${Math.round(val)}`,PAD.left-4,y+4);
    }
    if(minVal<0&&maxVal>0){
        const zy=toY(0);
        ctx.strokeStyle='rgba(0,0,0,0.15)';ctx.lineWidth=1.5;ctx.setLineDash([4,3]);
        ctx.beginPath();ctx.moveTo(PAD.left,zy);ctx.lineTo(W-PAD.right,zy);ctx.stroke();
        ctx.setLineDash([]);
    }
    ctx.fillStyle='#9ca3af';ctx.font='10px sans-serif';ctx.textAlign='center';
    const step=Math.max(1,Math.floor(scores[0].length/8));
    scores[0].forEach((_,i)=>{if(i%step===0||i===scores[0].length-1)ctx.fillText(i,toX(i),H-PAD.bottom+15);});
    ctx.fillStyle='#555';ctx.font='11px sans-serif';ctx.fillText('å±€æ•¸',W/2,H-2);
    game.players.forEach((p,pi)=>{
        const color=CHART_COLORS[pi];
        ctx.strokeStyle=color;ctx.lineWidth=2.5;ctx.lineJoin='round';
        ctx.beginPath();
        scores[pi].forEach((v,i)=>{if(i===0)ctx.moveTo(toX(i),toY(v));else ctx.lineTo(toX(i),toY(v));});
        ctx.stroke();
        const last=scores[pi].length-1;
        ctx.fillStyle=color;ctx.beginPath();ctx.arc(toX(last),toY(scores[pi][last]),5,0,Math.PI*2);ctx.fill();
        ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(toX(last),toY(scores[pi][last]),2.5,0,Math.PI*2);ctx.fill();
    });
    const legend=document.getElementById(`chartLegend_${index}`);
    if(legend){
        legend.innerHTML=game.players.map((p,i)=>`
            <div class="legend-item">
                <div class="legend-dot" style="background:${CHART_COLORS[i]};"></div>
                <span>${p.emoji||''} ${p.name}ï¼ˆ${p.score>=0?'+':''}$${p.score}ï¼‰</span>
            </div>`).join('');
    }
}
function closeSavedGameModal(){document.getElementById('savedGameModal').classList.remove('active');}

window.onload=init;
</script>
</body>
</html>
